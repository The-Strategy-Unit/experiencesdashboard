---
title: "Summary report"
author: "Chris Beeley"
output: word_document
params:
  dates: NA
  inputs: NA
  data: NA
  options: NA
  comment_1: NA
  comment_2: NA
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

# produce dataset for unique individuals
  
unique_data <- params$data %>% 
  dplyr::distinct(pt_id, .keep_all = TRUE)

# where is this report for?

if(isTruthy(params$inputs$location_3)){
  
  location <- params$inputs$location_3
  
} else if(isTruthy(params$inputs$location_2)){
  
  location <- params$inputs$location_2
  
} else if(isTruthy(params$inputs$location_1)){
  
  location <- params$inputs$location_1
} else { # nothing selected
  
  location <- "the whole trust"
}

```

## Summary

This report summarises data from `r format(params$dates[1], "%b %d %Y")` to `r format(params$dates[2], "%b %d %Y")`, within `r location`.

```{r, results = "asis"}

if("category_table" %in% params$options){
  
  cat("## Themes  \n")
  
  cat("###", params$comment_1,  "  \n")
  
  calculate_table(
    table_data = params$data, 
    count_column = "category",
    comment_type = "comment_1", 
    click_column = NULL
  ) %>% 
    pander::pandoc.table()
  
  cat("  \n")
  
  cat("###", params$comment_2,  "  \n")
  
  calculate_table(
    table_data = params$data, 
    count_column = "category",
    comment_type = "comment_2", 
    click_column = NULL
  ) %>% 
    pander::pandoc.table()
  
  cat("  \n")
  
}

```

```{r, results = "asis"}

if("verbatim_comments" %in% params$options){
  
  cat("## Verbatim comments  \n")
  
  cat("Note that in the interests of brevity comments where the respondent 
      indicated 'couldn't be improved' are omitted  \n")
  
  cat("  \n")
  
  cat("###", params$comment_1,  ": Comments  \n")
  
  verbatim_comments(params$data, 'comment_1')
  
  cat("###", params$comment_2,  ": Comments  \n")
  
  verbatim_comments(params$data, "comment_2")

}
```

```{r, results = "asis"}

if("sample_demographics" %in% params$options){

  cat("## Demographic features of sample  \n")
  
  cat("### Age  \n")
  
  print(demographic_distribution(unique_data, "age"))
  
  cat("  \n")
  cat("  \n")
  
  cat("### Gender  \n")
  
  print(demographic_distribution(unique_data, "gender"))
  
  cat("  \n")
  cat("  \n")
  
  cat("### Ethnicity  \n")
  
  print(demographic_distribution(unique_data, "ethnicity"))
  
  cat("  \n")
    
}

```


```{r, results = "asis"}

if("fft_graph" %in% params$options){
  
  cat("## FFT  \n")
  
  graph_data <- split_data_spc(
    unique_data, variable = "fft", chunks = 15
  )
  
  # confirm we have more than 3 groups to plot
  no_group <- graph_data %>% 
    dplyr::pull() %>% 
    unique() %>% 
    length()
  
   
  if (no_group < 3){
    
     print(p('There are not enough stable SPC points to plot.
                    Please expand your selection'))
    
  } else{

    print(plot_fft_spc(graph_data))
    
  }
  
  cat("  \n")
  
}

```

